<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="./todo-list.css">
</head>
<body>

</body>
</html>
<script>
  var todoList = []
  var showCategory = 'All'
  function update () {
    if (todoList.length === 0) {
      showCategory = 'All'
    }
    document.body.innerHTML = `
    <section class="todoapp" id="app">
      <header class="header">
        <h1>todos</h1>
        <input class="new-todo" />
      </header>
      <section class="main">
        <input id="toggle-all" class="toggle-all" type="checkbox" ${todoList.every(it => it.done) && todoList.length > 0 ? 'checked' : ''}/>
        <label for="toggle-all">Mark all as complete</label>
        <ul class="todo-list">
          ${todoList.map((it, index) => `
            <li class="${it.done ? 'completed': ''}" style="display: ${showItem(it.done) ? 'list-item' : 'none'}">
              <div class="view">
                <input class="toggle" type="checkbox" ${it.done ? 'checked': ''}/>
                <label>${it.text}</label>
                <button class="destroy"></button>
              </div>
                <input class="edit" type="text" value="${it.text}"/>
            </li>
          `).join('')}
        </ul>
      </section>
      ${todoList.length > 0 ? `
        <footer class="footer">
          <span class="todo-count">
            <strong>${todoList.filter(it => !it.done).length}</strong> items left
          </span>
          <ul class="filters">
            <li><a class="${showCategory === 'All' ? 'selected' : ''}">All</a></li>
            <li><a class="${showCategory === 'Active' ? 'selected' : ''}">Active</a></li>
            <li><a class="${showCategory === 'Completed' ? 'selected' : ''}">Completed</a></li>
          </ul>
          <button class="clear-completed" style="display: ${todoList.some(it => it.done) ? 'inline' : 'none'}">Clear completed</button>
        </footer>` : ''
      }
    </section>
    `
  }
  update()
  
  // 筛选显示项目
  function showItem (status) {
    if (showCategory === 'All') {
      return true
    }
    if (status) {
      return showCategory === 'Completed'
    } else {
      return showCategory === 'Active'
    }
  }
  // 获取列表条目索引
  function getTodoIndex (el) {
    var li = el
    while(!li.matches('li')) {
      li = li.parentElement
    }
    var lis = li.parentElement.querySelectorAll('li')
    return Array.prototype.indexOf.call(lis, li)
  }

  document.addEventListener('keyup', (e) => {
    var target = e.target
    // 添加
    if (target.matches('.new-todo')) {
      var val = target.value.trim()
      if (e.keyCode === 13 && val) {
        todoList.push({
          done: false,
          text: val
        })
        update()
        target.focus()
      }
    }
  })
  document.addEventListener('click', (e) => {
    var target = e.target
    // 筛选
    if (target.matches('.filters a')) {
      showCategory = target.textContent
      update()
    }

    // 清除完成的
    if (target.matches('.clear-completed')) {
      todoList = todoList.filter(item => !item.done)
      update()
    }
    
    // 是否完成
    if (target.matches('input.toggle')) {
      var index = getTodoIndex(target)
      todoList[index].done = !todoList[index].done
      update()
    }
    
    // 删除条目
    if (target.matches('li button')) {
      var index = getTodoIndex(target)
      todoList.splice(index, 1)
      update()
    }

    // 全选
    if (target.matches('label[for=toggle-all]')) {
      var checked = target.previousElementSibling.checked
      todoList.forEach(it => {
        it.done = !checked
      })
      update()
    }
    // 
  })

  // 修改条目
  document.addEventListener('dblclick', (e) => {
    var target = e.target
    var index = getTodoIndex(e.target)
    var lis = document.querySelectorAll('.todo-list li')
    var editInput = lis[index].querySelector('.edit')
    var editText = todoList[index].text
    lis[index].classList.add('editing')
    editInput.focus()

    editInput.addEventListener('blur', (e) => {
      editText = e.target.value.trim()
      lis[index].classList.remove('editing')
      if (editText) {
        todoList[index].text = editText
      } else {
        todoList.splice(index, 1)
      }
      update()
    })

    editInput.addEventListener('keyup', (e) => {
      if (e.keyCode === 13 || e.keyCode === 27) {
        e.target.blur()
      }
    })
  })
</script>