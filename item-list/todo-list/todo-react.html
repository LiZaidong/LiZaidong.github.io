<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello World</title>
    <link rel="stylesheet" href="./todo-list.css">
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    
    <!-- Don't use this in production: -->
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      class TodoApp extends React.Component {
        constructor (props) {
          super(props)
          this.state = {
            todoList: [],
            editingIndex: -1,
            editingText: '',
            currentStatus: -1
          }

          this.checkedAll = this.checkedAll.bind(this)
          this.clear = this.clear.bind(this)
          this.showItem = this.showItem.bind(this)
        }
        // 添加条目
        addTodo (e) {
          if (e.keyCode === 13) {
            let value = e.target.value.trim()
            this.setState(prevState => {
              // return prevState.todoList.push({text: value, done: false})

              return {todoList: [...prevState.todoList, {text: value, done: false}]}
            })
            // debugger
            e.target.value = ''
          }
        }

        // 删除条目
        del (index) {
          this.setState(prevState => {
            prevState.todoList.splice(index, 1)
            return prevState.todoList
          })
        }

        // 条目完成与否
        isCompleted (index) {
          this.setState(prevState => {
            let status = prevState.todoList[index].done
            prevState.todoList[index].done = !status
            this.checkedAll()
            return prevState
          })
        }
        // 修改条目
        edit (index, e) {
          e.persist()
          const next = e.currentTarget.nextElementSibling
          this.setState({
            editingIndex: index,
            editingText: this.state.todoList[index].text
          })
          setTimeout(() => {
            // next.focus()
            // console.log(this.refs.editTodo)
            this.refs.editTodo.focus()
          })
        }
        // 修改完
        edited (index, e) {
          e.persist()
          let value = e.target.value.trim()
          this.setState((prevState) => {
            if (value) {
              prevState.todoList[index].text = e.target.value
            } else {
              prevState.todoList.splice(index, 1)
            }
            prevState.editingIndex = -1
            prevState.editingText = ''
            return prevState
          })
        }
        // 修改回车，退出
        exit (index, e) {
          e.persist()
          if (e.keyCode === 27 || e.keyCode === 13) {
            e.target.blur()
          }
        }
        // 未完成数量
        activityCount () {
          return this.state.todoList.filter(it => !it.done).length
        }
        // 是否全选 
        checkedAll () {
          return this.state.todoList.every(it => it.done) && this.state.todoList.length > 0
        }
        // 全选点击 
        toggleCheck (e) {
          const checkAll = e.target.checked
          this.setState(prevState => {
            prevState.todoList.forEach(item => {
              item.done =  checkAll
            })
            return prevState
          })
        }
        // 清除完成
        clear () {
          let list = this.state.todoList.filter(it => !it.done)
          this.setState({
            todoList: list
          })
        }
        // 更改显示状态
        checkStatus (status) {
          this.setState({'currentStatus': status})
        }
        // 切换状态显示的item
        showItem (completed) {
          completed = this.state.currentStatus === -1 || this.state.currentStatus == completed
          completed = completed ? 'block' : 'none'
          return {
            display: completed
          }
        }
        componentDidMount () {
          this.checkedAll()
        }
        render() {
          console.log(this.state)
          return (
            <section className="todoapp"id="app">
              <header className="header">
                <h1>todos</h1>
                <input 
                  className="new-todo" 
                  onKeyUp={this.addTodo.bind(this)}
                />
              </header>
              <section className="main">
                <input 
                  id="toggle-all" 
                  className="toggle-all" 
                  type="checkbox" 
                  checked={this.checkedAll()}
                  onChange={this.toggleCheck.bind(this)}
                />
                <label htmlFor="toggle-all">Mark all as complete</label>
                <ul className="todo-list">
                  {
                    this.state.todoList.map((item, index) => {
                      return (
                        <li 
                          key={index} 
                          className={[this.state.editingIndex === index ? 'editing' : '', item.done ? 'completed' : ''].join(' ')}
                          style={this.showItem(item.done)}
                        >
                          <div 
                            className="view"
                            onDoubleClick={this.edit.bind(this, index)}
                          >
                            <input 
                              className="toggle" 
                              type="checkbox" 
                              onChange={this.isCompleted.bind(this, index)}
                              checked={item.done}
                            />
                            <label>{item.text}</label>
                            <button className="destroy" onClick={this.del.bind(this, index)}></button>
                          </div>
                          {this.state.editingIndex === index &&
                            <input 
                              className="edit" 
                              type="text" 
                              ref="editTodo"
                              defaultValue={this.state.editingText}
                              onBlur={this.edited.bind(this, index)}
                              onKeyUp={this.exit.bind(this, index)}
                            />
                          }
                        </li>
                      )
                    })
                  }
                </ul>
              </section>
              {this.state.todoList.length ? 
                <footer className="footer">
                <span className="todo-count">
                  <strong>{this.activityCount()}</strong> items left
                </span>
                <ul className="filters">
                  <li><a 
                    onClick={this.checkStatus.bind(this, -1)}
                    className={this.state.currentStatus === -1 ? 'selected' : ''}
                  >All</a></li>
                  <li><a 
                    onClick={this.checkStatus.bind(this, 0)}
                    className={this.state.currentStatus === 0 ? 'selected' : ''}
                  >Active</a></li>
                  <li><a 
                    onClick={this.checkStatus.bind(this, 1)}
                    className={this.state.currentStatus === 1 ? 'selected' : ''}
                  >Completed</a></li>
                </ul>
                {
                  this.activityCount() !== this.state.todoList.length &&
                  <button className="clear-completed" onClick={this.clear}>
                    Clear completed
                  </button>
                }
              </footer> : ''}
            </section>
          )
        }
      }
      ReactDOM.render(
        <div>
          <TodoApp />
        </div>,
        document.getElementById('root')
      );
    </script> 
  </body>
</html>